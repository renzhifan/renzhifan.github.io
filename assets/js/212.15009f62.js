(window.webpackJsonp=window.webpackJsonp||[]).push([[212],{624:function(s,a,n){"use strict";n.r(a);var e=n(33),t=Object(e.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("blockquote",[n("p",[s._v("在rabbitmq中，当消息在一个队列中变成一个死信（消费者无法处理的消息）之后，它将被重新投递到另一个交换机上，这个交换机我们就叫做死信交换机，死信交换机将死信投递到一个队列上就是死信队列。")])]),s._v(" "),n("blockquote",[n("p",[s._v("死信队列示意图")])]),s._v(" "),n("p",[n("img",{attrs:{src:"https://raw.githubusercontent.com/renzhifan/upic_img/master/uPic/2022/05/16/11-56-06-sS6468-xpkHNi.jpg",alt:"11-56-06-sS6468-xpkHNi"}})]),s._v(" "),n("p",[s._v("上图描述了，死信的产生到处理整个过程。")]),s._v(" "),n("h2",{attrs:{id:"死信的产生"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#死信的产生"}},[s._v("#")]),s._v(" 死信的产生")]),s._v(" "),n("ul",[n("li",[s._v("消息被消费者手动拒绝(basic.reject / basic.nack)，并且requeue = false")]),s._v(" "),n("li",[s._v("消息TTL（消息存活时间）过期")]),s._v(" "),n("li",[s._v("队列达到最大长度")])]),s._v(" "),n("h2",{attrs:{id:"死信队列处理步骤"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#死信队列处理步骤"}},[s._v("#")]),s._v(" 死信队列处理步骤")]),s._v(" "),n("ul",[n("li",[s._v("定义一个死信交换机（别被名字误导，就是一个普通的交换机，只不过用在了死信处理场景，才叫这个名字）")]),s._v(" "),n("li",[s._v("定义一个队列绑定死信交换机（这个队列就叫死信队列，也是一个普通队列）")]),s._v(" "),n("li",[s._v("定义死信消费者，消费死信队列（别被名字误导，这也是普通的消费者）")]),s._v(" "),n("li",[s._v("将死信交换机绑定到指定队列上（那个队列需要处理死信就绑定谁）")])]),s._v(" "),n("h2",{attrs:{id:"golang处理死信队列"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#golang处理死信队列"}},[s._v("#")]),s._v(" Golang处理死信队列")]),s._v(" "),n("h3",{attrs:{id:"_1-定义死信交换机"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-定义死信交换机"}},[s._v("#")]),s._v(" 1.定义死信交换机")]),s._v(" "),n("p",[s._v("当成普通交换机定义就行。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('// 声明交换机\n    err = ch.ExchangeDeclare(\n        "deadExchange",   // 交换机名字\n        "topic", // 交换机类型\n        true,     // 是否持久化\n        false,\n        false,\n        false,\n        nil,\n    )\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("h3",{attrs:{id:"_2-定义死信队列"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-定义死信队列"}},[s._v("#")]),s._v(" 2.定义死信队列")]),s._v(" "),n("p",[s._v("当成普通队列定义就行")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v(' // 声明队列\n    q, err := ch.QueueDeclare(\n        "",    // 队列名字，不填则随机生成一个\n        false, // 是否持久化队列\n        false,\n        true,\n        false,\n        nil,\n    )\n\n    // 队列绑定死信交换机\n    err = ch.QueueBind(\n        q.Name, // 队列名\n        "#",     // 路由参数，# 井号的意思就匹配所有路由参数，意思就是接收所有死信消息\n        "deadExchange", // 死信交换机名字\n        false,\n        nil)\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("h3",{attrs:{id:"_3-定义死信消费者"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-定义死信消费者"}},[s._v("#")]),s._v(" 3.定义死信消费者")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('// 创建消费者\n    msgs, err := ch.Consume(\n        q.Name, // 引用前面的死信队列名\n        "",     // 消费者名字，不填自动生成一个\n        true,   // 自动向队列确认消息已经处理\n        false, \n        false, \n        false, \n        nil,\n    )\n\n    // 循环消费死信队列中的消息\n    for d := range msgs {\n        log.Printf("接收死信消息=%s", d.Body)\n    }\n\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("h2",{attrs:{id:"_4-将死信交换机绑定到指定队列"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-将死信交换机绑定到指定队列"}},[s._v("#")]),s._v(" 4.将死信交换机绑定到指定队列")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('  // 队列属性\n    props := make(map[string]interface{})\n    // 绑定死信交换机\n    props["x-dead-letter-exchange"] = "deadExchange"\n    // 可选: 设置死信投递到死信交换机的时候的路由参数，如果不设置，则使用消息原先自带的路由参数\n    // props["x-dead-letter-routing-key"] = "www.sss.com"\n\n    q, err := ch.QueueDeclare(\n        "demo.hello", // 队列名\n        true,   // 是否持久化\n        false, \n        false, \n        false,   \n        props,     // 设置队列属性\n    )\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("p",[s._v("这样，只要"),n("strong",[s._v("demo.hello")]),s._v("队列的消息变成死信的话，消息会被转发到"),n("strong",[s._v("deadExchange")]),s._v("死信交换机。")])])}),[],!1,null,null,null);a.default=t.exports}}]);