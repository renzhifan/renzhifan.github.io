(window.webpackJsonp=window.webpackJsonp||[]).push([[73],{489:function(s,a,n){"use strict";n.r(a);var e=n(33),t=Object(e.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"php-ini优化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#php-ini优化"}},[s._v("#")]),s._v(" php.ini优化")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("//默认情况下服务器对上传文件的大小是有限制的，如果想修改上传文件的限制可以修改php.ini文件\nfile_uploads = On; //是否允许上传文件 \nupload_max_filesize = 1024M; //上传文件的最大限制\n\npost_max_size = 1024M; //通过post提交的最多数据\n\nmax_execution_time = 300; //脚本最长的执行时间 单位为秒\nmax_input_time = 30000; //接收提交的数据的时间限制 单位为秒\nmemory_limit = 256M; //每个脚本使用的最大内存  ;在安全模式下，你不能用ini_set()在运行时改变这个设置。\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("h2",{attrs:{id:"php-fpm优化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#php-fpm优化"}},[s._v("#")]),s._v(" php-fpm优化")]),s._v(" "),n("h3",{attrs:{id:"_1-如何启用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-如何启用"}},[s._v("#")]),s._v(" 1.如何启用？")]),s._v(" "),n("p",[s._v("编译安装时加上--enable-fpm")]),s._v(" "),n("h3",{attrs:{id:"_2-如何优化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-如何优化"}},[s._v("#")]),s._v(" 2.如何优化?")]),s._v(" "),n("p",[s._v("优化之前根据业务需求规划，然后必须做压力测试；\n优化的主要文件就是"),n("code",[s._v("php-fpm.conf")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("(1)进程数设置\n\n pm = dynamic\n\n pm.max_children = 15  //静态方式下开启的php-fpm进程数量\n\n pm.start_servers = 5    //动态方式下的起始php-fpm进程数量\n\n pm.min_spare_servers = 5 //动态方式下 空闲时间最小的php-fpm进程\n\n pm.max_spare_servers = 5 //动态方式下 空闲时间最大的php-fpm进程\n\n(2)最大处理请求数\n\n最大处理请求数是指一个php-fpm的worker进程在处理多少个请求后就终止掉，master进程会重新respawn新的。\n\n该配置可以避免php解释器自身或程序引起的memory leaks。\n\n默认值是500，\n\npm.max_requests = 1024\n\n这样的规划，1秒钟\n\n最大请求数：15*1024=15360\n\n最小请求数：5*1024=7120\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br")])]),n("h2",{attrs:{id:"如何避免程序hang死"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#如何避免程序hang死"}},[s._v("#")]),s._v(" 如何避免程序hang死？")]),s._v(" "),n("h3",{attrs:{id:"方法1-设置php-fpm执行的超时时间为固定值"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#方法1-设置php-fpm执行的超时时间为固定值"}},[s._v("#")]),s._v(" 方法1：设置php-fpm执行的超时时间为固定值")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#vi php-fpm.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("修改为request_terminate_timeout = 60")]),s._v(" "),n("h3",{attrs:{id:"方法2-定时reload-php-fpm"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#方法2-定时reload-php-fpm"}},[s._v("#")]),s._v(" 方法2：定时reload php-fpm")]),s._v(" "),n("p",[s._v("在负载较高的服务器上定时重载php-fpm\nreload可以平滑重启而不影响生产系统的php脚本运行")]),s._v(" "),n("p",[s._v("每15分钟reload一次")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("0-59/15 * * * * /usr/local/php/sbin/php-fpm reload\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"优化进程池配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#优化进程池配置"}},[s._v("#")]),s._v(" 优化进程池配置")]),s._v(" "),n("p",[n("strong",[s._v("php-fpm根据配置文件内容和实际情况，动态创建子进程来处理请求。当达到能够创建的最大值时，只能阻塞。一个个地进行执行。")])]),s._v(" "),n("ul",[n("li",[s._v("进程数优化")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("pm = dynamic\n\npm.max_children = 300\n\npm.start_servers = 20\n\npm.min_spare_servers = 5\n\npm.max_spare_servers = 35\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("ul",[n("li",[s._v("最大请求数优化\npm.max_requests = 10240\n提示: 这个用来处理因为PHP解析器或引用的第三方库时，造成的内存泄露问题。\n最大请求数：指一个php-fpm的工作进程在处理多少个请求后就终止掉。")]),s._v(" "),n("li",[s._v("最长执行时间优化（php.ini）\nrequest_terminate_timeout = 20\n提示:这个是用来处理因为PHP执行时间超长而报502错误的解决。\n这个时长配置可以在php.ini（max_execution_time）或php-fpm.conf中配置均可，为了不影响全局配置，可在php-fpm.conf中实现")])]),s._v(" "),n("h3",{attrs:{id:"crontab定时任务把php-fpm平滑重启"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#crontab定时任务把php-fpm平滑重启"}},[s._v("#")]),s._v(" crontab定时任务把php-fpm平滑重启")]),s._v(" "),n("p",[s._v("这种方式就是使用crontab定时任务去定时查询网站是否502了，如果502了，就把php-fpm平滑重启。\n首先在/root/目录下面创建脚本。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("vim restart-php-fpm.sh\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("然后给这个脚本赋予执行权限。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("chmod +x /root/restart-php-fpm.sh\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("然后就是编写脚本内容了，上代码。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('#!/bin/bash\nMY_URL="https://www.****.com/"\nRESULT=`curl -I $MY_URL|grep "HTTP/1.1 502"`\nif [ -n "$RESULT" ]; then\n    /etc/init.d/php7.4-fpm restart\nfi\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("blockquote",[n("p",[s._v("注意：我是使用的/etc/init.d/php7.4-fpm restart这种方式重启的")])]),s._v(" "),n("p",[s._v("然后编写定时任务")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("crontab -e\n* * * * * /root/restart-php-fpm.sh\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("用crontab -l查看定时任务列表")])])}),[],!1,null,null,null);a.default=t.exports}}]);